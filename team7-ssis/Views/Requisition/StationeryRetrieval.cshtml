@model team7_ssis.ViewModels.StationeryRetrievalViewModel

@section Scripts {
    <script src="~/Scripts/Custom/RedirectPost.js"></script>
}

@{
    ViewBag.Title = "StationeryRetrieval";
}

@if (Request.QueryString["msg"] != null)
{
<div class="alert alert-primary mb-3" role="alert">
    <i class="fa fa-exclamation-circle" aria-hidden="true"></i> @Request.QueryString["msg"]
</div>
}

<div id="alert"></div>

<div class="row mb-3 step__container">
    <div class="step__arrow"><i class="fa fa-arrow-right" aria-hidden="true"></i></div>
    <div class="col-md-6">
        <a>
            <div class="card">
                <div class="card-body">
                    <div class="step__icon">
                        <i class="fa fa-archive" aria-hidden="true"></i>
                    </div>
                    <div class="step__label">
                        <h5>Stationery Retrieval</h5>
                        Collect items below from store.
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-6">
        <a>
            <div class="card">
                <div class="card-body">
                    <div class="step__icon">
                        <i class="fa fa-truck" aria-hidden="true"></i>
                    </div>
                    <div class="step__label">
                        <h5>Stationery Disbursement</h5>
                        Deliver items according to Disbursement Forms.
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <div>Retrieval ID</div>
        @Model.RetrievalID<br />
        <i class="fa fa-print" aria-hidden="true"></i>

    </div>
    <div class="col-md-4">
        <div class="col-md-12">
            <div>Created By</div>
            @Model.CreatedBy
        </div>
        <div class="col-md-12">
            <div>Created On</div>
            @Model.CreatedOn
        </div>
    </div>
    <div class="col-md-4">
        <div class="col-md-12">
            <div>Updated By</div>
            @Model.UpdatedBy
        </div>
        <div class="col-md-12">
            <div>Updated On</div>
            @Model.UpdatedOn
        </div>
    </div>
</div>

<table id="myTable" class="table table-striped table-bordered" style="width: 100%">
    <thead>
        <tr>
            <th>All Retrieved?</th>
            <th>Product ID</th>
            <th>Bin</th>
            <th>Description</th>
            <th>Qty Ordered</th>
            <th>Edit</th>
        </tr>
    </thead>

</table>

<div class="row mt-3">
    <div class="col-md-12">
        <div class="pull-right">
            <button id="discardChangesBtn" class="btn btn-default"><i class="fa fa-times" aria-hidden="true"></i> Discard Changes</button>
            <button id="updateRetrievalBtn" class="btn btn-primary"><i class="fa fa-check" aria-hidden="true"></i> Update Retrieval Form</button>
        </div>
        
    </div>
</div>

<script>

    // icons representing checked/unchecked
    var checked = '<i class="fa fa-check-square-o" aria-hidden="true"></i>';
    var unchecked = '<i class="fa fa-square-o" aria-hidden="true"></i>';

    // load script
    $(document).ready(function () {
        var table = $('#myTable').DataTable({
            ajax: {
                url: "/api/stationeryretrieval/@Model.RetrievalID",
                dataSrc: ""
            },

            columns: [
                //{ "defaultContent": '<i class="fa fa-square-o" aria-hidden="true"></i>', className : "checkmark" },
                {
                    "data": "AllRetrieved",
                    "className": "checkmark pointer",
                    "render": function (data, type, row, meta) {
                        return data ? checked : unchecked;
                    }
                },
                { "data": "ProductID", "autoWidth": true },
                { "data": "Bin", "autoWidth": true },
                { "data": "Description", "autoWidth": true },
                { "data": "QtyOrdered", "autoWidth": true },
                { "defaultContent": "<button class='btn btn-primary editbutton'><i class='fa fa-pencil' aria-hidden='true'></i></button>" },
            ],
            select: 'api'
        });

        // click edit button
        $(document).on("click", ".editbutton", function () {
            //console.log('clicked');
            var itemcode = $(this).parent().siblings('td:nth-of-type(2)').html();
            var redirectURL = "/Retrieval/RetrievalDetails?retId=@Request.QueryString["rid"]&itemId=" + itemcode;
            window.location.href = redirectURL;
        });

        // toggle checkboxes
        $('#myTable tbody').on('click', '.checkmark', function () {
            console.log('clicked');
            var cell = table.cell(this);
            if (cell.data() == true) {
                cell.data(false).draw();
            } else if (cell.data() == false) {
                cell.data(true).draw();
            }
        });

        $(document).on('click', '#updateRetrievalBtn', function () {
            var rowData = table.rows().data().toArray();
            //var data = [];
            //for (i = 0; i < data.length; i++) {
            //    data[i] = { AllRetrieved: , ProductID: }
            //};

            var json = {
                RetrievalID: "@Request.QueryString["rid"]",
                Data: rowData
            };

            console.log(json);

            $.ajax({
                type: "POST",
                contentType: 'application/json',
                url: "/api/stationeryretrieval",
                data: JSON.stringify(json),
                success: function (message) {
                    // create info DOM object
                    console.log(message);
                    $('#alert').html('<div class="alert alert-info" role="alert">Disbursement information updated.</div >');
                },
                error: function (message) {
                    // show error message
                    console.log(message.statusText);
                    $('#alert').html('<div class="alert alert-danger" role="alert">An unexpected error occured.</div >');
                }
            })
        });

    });

    
</script>